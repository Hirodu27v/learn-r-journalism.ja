##ggplot2でチャートを作る

データをロードしてチャートを作成し、レイヤーを細分化しましょう。

[Vulture.com](http://www.vulture.com/2013/04/leading-men-age-but-their-love-interests-dont.html) から、映画の主演男優と恋の相手の年齢を比較したデータをいくつか紹介します。


```{r importing_data, warning=F, message=F}
library(readr)

ages <- read_csv("data/ages.csv")

head(ages)
```
これが私たちが扱うデータです。

変数/列は、映画の題名、ジャンル、俳優、俳優の年齢、女優、女優の年齢、予算です。

これがチャートです。 コンソールで実行してください。

```{r chart_example, warning=F, message=F}
# If you haven't installed the ggplot2 package yet, uncomment and run the line below
#install.packages("ggplot2")

library(ggplot2)

ggplot(data=ages) +
   geom_point(mapping=aes(x=actor_age, y=actress_age)) +
   expand_limits(x = 0, y = 0) +
   geom_abline(intercept=0, col="light gray")

```

このチャートは何を示していますか？映画の中で、男性は女性よりもはるかに年上です。

このチャートの構成要素を分解しましょう。

![](/visualizing/charts_with_ggplot/images/gg1.png)

まずは　**データフレーム**　からです。 **年齢**　を`ggplot()`に渡して初期化しました。


![](/visualizing/charts_with_ggplot/images/gg1c.png)

![](/visualizing/charts_with_ggplot/images/gg2.png)

次に、視覚化するために選択したデータがドットでx軸とy軸に表示されます。

マッピングは、aestheticsがデータ内の変数とどのように関連するかを記述します。

![](/visualizing/charts_with_ggplot/images/gg2c.png)

データを視覚的特性として表す　**aesthetics** (`aes()`) を設定します。

デフォルトの幾何学的オブジェクトと色を使用していますが、これらはカスタマイズ可能です。

* ポジション
* サイズ
* 色
* 形状
* 透明度
* 塗りつぶし

それぞれの **aesthetic**　に対して、 視覚的特性をどのように表示値に変換するか **scales** を設定できます。後でやってみましょう。

`ggplot()`に追加した `geom_`関数を見てみましょう。

![](/visualizing/charts_with_ggplot/images/gg2d.png)

**ggplot2** では関数の間にプラスを忘れずに。

`%>%` パイピングを実装した **dplyr** の前に作成されました。

パイピングのショートカットは私には条件反射的なので、とても混乱しがちです。

ggplotを使っているのであれば、プラス！

そうでなければ、パイプ！


![](/visualizing/charts_with_ggplot/images/gg2e.png)

So `geom_point()` は `geom_bar()` や `geom_boxplot()`のように *geom_functions*　のうちの１種類です。

*geom_function* に関わらず *mappings* に渡す必要があります。

このチャートのインスタンスでは、**ages**　の **actor_age** と **actress_age** に当たります。

これがRで`ggplot()` とデータ、`geom_`と`aes()`を使って.チャートを作成する基本です。この例にある他の2行を実行する必要はありません。

さらにわかりやすくするために説明を追加しました。

![](/visualizing/charts_with_ggplot/images/gg3.png)

![](/visualizing/charts_with_ggplot/images/gg3.png)

次の行は拡大・縮小のオプションです。

スケーリングは *geom_function*　の`aes()`に渡してもできますが、チャート全体にも適用できます。


![](/visualizing/charts_with_ggplot/images/gg3c.png)
このチャートでは、 `expand_limits()` 関数でX軸とY軸を０からスタートするように表示できます。

そうしない場合、 `ggplot()`はチャート内の点がチャート全体を埋めるようにスケールをシフトします。データが含まれていない余計な余白が求められていないと仮定するのです。

しかし、このデータは０から始めることで年齢の格差を強調します。 さらに、（いくつかの例外があるものの）ベースをゼロから開始しないことで見落とすかもしれないデータ視覚化の上での長所がたくさんあります。


![](/visualizing/charts_with_ggplot/images/gg4.png)

これまでに見てきたたくさんの関数の最後を飾るのは `ab_line()`です。 必須ではありませんが、 **ggplot2**　の階層化オプションの一部です。

![](/visualizing/charts_with_ggplot/images/gg4c.png)

 **ggplot2** の `geom_abline()` のような関数は追加の変数を渡すことができます。 この例では、切片を1、バーの色を「ライトグレー」に指定します。  `geom_abline()` に変数を渡さず、行はデフォルト幅にしましょう。


![](/visualizing/charts_with_ggplot/images/gg5.png)

それでは、他にもチャートを作ってみましょう。

しかしまずは、データについて考えてみましょう。

## データ

 `ggplot2()`の使用に際し、手元のデータの構造を理解することはとても重要です。

```{r head}

head(ages)

```

このデータフレームには6つの変数（列）があります。

各行は単一の映画のデータを表しており、とても整っています。

きちんとしたフォーマットがあるように見えますが、すべてのデータセットがデフォルトでこの構造を持つわけではありません。

広いデータと長いデータを扱った前の章を思い出してください。

![](/visualizing/charts_with_ggplot/images/wide.png)

各人種の変数は列に分散されています。

スプレッドシートの見栄えがよくなるだけで、 **ggplot2** ではうまくいきません。

![](/visualizing/charts_with_ggplot/images/long.png)

これでよし。各行には異なる変数が入っています。このようにして、メトロと人種あたりの解決率、事件数の合計に別の変数を追加できます。

より多機能です。

 `ggplot()`では、データは整えられ、長い（背が高い）フォーマットが最もうまくいくのです。

