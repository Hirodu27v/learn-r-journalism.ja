---
title: "Introduction to R"
description: "Functions, syntax, directories, workspace, libraries"
author: "Andrew Ba Tran"
date: 2018-05-27T21:13:14-05:00
categories: ["R"]
tags: ["R", "introduction"]
weight: 2
slug: intro-to-r
---

## 構文

Rが機能するためには、厳格な構文規則に従わなければなりません。Rはあなたの意図を推測しないのです。

![](/how_to_use_r/tour_rstudio/images/left.png?classes=shadow)

* Rは（SQLとは異なり）大文字と小文字を区別し、（Cと違って）[インタプリタ型言語](https://en.wikipedia.org/wiki/Interpreted_language) です。
* プロンプト `>` からコマンドを入力できます。
* コメントの前には `#`　を入れてください。
    * コメントは内容が他の人にも分かるように使いましょう。
    * このコースでもよく見ることでしょう。
* 文は、関数やオブジェクトの割り当てなどを記述するコード行です。
    * （新しい行のように）コードの途中でエンター、またはセミコロンを入力すると、文が区切られます。


## ワーキングディレクトリ

*ワーキングディレクトリ* は、現在作業しているコンピュータ上のフォルダです。あるファイルを開くようRに要求すると、そのファイルのワーキングディレクトリを調べます。データファイルや図を保存するようにRに指示すると、ワーキングディレクトリに保存します。

作業を開始する前には、すべてのデータとスクリプトファイルが保存されている場所をワーキングディレクトリとして設定してください。


{{% notice tip %}}
このクラスで、背景が黒い部分にコードがある場合は、 **特に記載がない限りRでそのコードを実行してください** 。コンソールで実行することもできますが、履歴を追えるようにスクリプトを使うのが望ましいと思います。ビデオでは、コンソールとスクリプトの間を行き来してコーディングをします。これは、コードをちょっと試しているのか、それとも腰を据えて取り組むのかによって異なります。普通は、コンソールで実行したコードをスクリプトにコピー＆ペーストすることになるでしょう。また、コマンドが失敗した場合の対処方法に関するヒントなど、追加の予備知識を提供しますので **コメントアウトされたコードは必ず読んでください。**
{{% /notice %}}

これは、作業ディレクトリをマニュアルディレクトリに設定する方法です。

```{r setwd, eval=F, warning=F, message=F}
# macなら
setwd("~/projects/learn-r-journalism")

# その他のPCなら
setwd("C:/Documents/learn-r-journalism")
```


{{% notice note %}}
スラッシュが普通のスラッシュであることを確かめ、そして引用符を忘れないようにしてください。.
{{% /notice %}}

RStudioでは　*Tools > Set Working Directory*　という手順で作業ディレクトリを設定することもできます。

<img src="/how_to_use_r/intro_to_r/images/setwd.png" alt="Set working directory", class="shadow", style="width:70%">



上記のコマンド `setwd()`はフォルダへの**絶対**パスの設定例です。

うまくいっているように見えますが、自分のやり方とスクリプトを共有したいとか、別のコンピュータでコードを実行して保存したいと思っても、元のスクリプトが書かれたコンピュータの他には存在しないフォルダ構造を調べようとするので、 **うまくいかない** でしょう。これは再現性の観点からすると理想的ではありません。


作業ディレクトリは難解な概念です。[Chapter 6](https://learn.r-journalism.com/en/publishing/) で最も良い手法をさらに詳しく説明します。 このリンクはあなたの [理解を助けてくれます](https://wangfanghelsinki.wordpress.com/2015/03/31/understanding-and-setting-rstudio-working-directory/) 。
## ライブラリ

Rは多くの統計的なデータ分析を行うことができます。
それらはいわゆる*パッケージ*や*ライブラリ*としてまとめられています。

Rではライブラリを追加しなくても、多くの統計分析を行うことができます。これをbase Rと呼びます。

しかし、その他にもユーザーは一般的な問題を解決するライブラリを作りました。Rパッケージの利用者は、それぞれのプロジェクトに必要なライブラリだけをダウンロードします。

インストールされているすべてのパッケージのリストを取得するには、パッケージウィンドウに移動するか、コンソールに`library()` と入力します。パッケージウィンドウで、パッケージ名の欄にチェックが入っている場合、既にパッケージがロードされ、その中の関数を呼び出す準備ができています。

RのWebサイトには、より多くのパッケージがあります。パッケージをインストールして使いたい場合（たとえば "dplyr" なら) :

* パッケージをインストール: `install packages`をクリックし、パッケージウィンドウに `dplyr` と入力するか、コンソールに`install.packages("dplyr")`と打ち込んでください。
* パッケージのロード: `dplyr`の前の欄にチェックを入れるか、コンソールに `library("dplyr")`と入力してください。

# Rコマンドの例

## 電卓

Rは電卓として使うことができます。

`>`の後にコンソールウィンドウに式を入力するだけです。

{{% notice note %}}
このセクションで、##が付いたコードは上の行のコードの出力を意味します。


```{r calc}
10^2 + 26
```
## [1] 126

## ワークスペース

数に名前を付けることもできます。

そうしておけば、後で使用できる、いわゆる変数になるのです。


```{r a4}
a <- 4
a
```
## [1] 4

 `a`を計算に使うことができるようになりました。

```{r amath}
a*5
```
## [1] 20
`a`を再び指定すると、割り当てが何もなかったため、以前に持っていた値は保持されていません。

```{r a_again}
a
```
## [1] 4

前の値を使用して`a` に新しい値を代入することもできます。

```{r a10}
a <- a + 10
a
```
## [1] 14
Rのメモリからすべての変数を削除するには、次のように入力します。

```{r rm}
rm(list=ls())
```

または、ワークスペースの "clear all" をクリックします。

<img src="/how_to_use_r/intro_to_r/images/clear_objects.png" alt="Set working directory", class="shadow", style="width:70%">

## スカラーとベクトル

多くのプログラムと同様に、Rは数を *スカラー* (大きさのみを持つ０次元の量), *ベクトル* (数列、配列とも呼びます) *行列* (今は深入りしません)に分類します。

先ほど定義した`a` はスカラーです。

3、4、5という数からなるベクトルを定義するには、連結（して貼り合わせる）の略である `c()` という関数が必要です。

```{r combine}
b=c(3,4,5)
b
```
## [1] 3 4 5

## 関数

上記の例で挙げたベクトル `b` のすべての要素の平均を計算したい場合は、次のように入力します。

```{r mean}
(3+4+5)/3
```
## [1] 4

しかし、とても長いベクトルになると、これは非常に煩雑です。

関数はデータを処理するためのもので、Rは関数で構築されています。`median()`や`summary()`のように、もともとRに付属している関数もあれば、作成したパッケージの一部として提供されている関数もあります。

平均を計算する関数は、次のようにタイプします。

```{r mean_two}
mean(x=b)
```
## [1] 4
（）には *引数*を入れます。

引数は関数に追加の情報を与えるものです。ここでは、引数*x*は、平均値を計算しようとしている数値の集合（ベクトル）を表します（すなわちb）。

引数の名前が不要な場合もあります。

```{r mean_three}
mean(b)
```
## [1] 4

これでも大丈夫です。

## プロット

Rは瞬時に簡単なグラフィックを作ることができます。

```{r norm_graph}
# rnorm() は、ランダム分布からランダムサンプルを生成する関数です。

x <- rnorm(100)

# plot() をチャート化する基本的な関数です。

plot(x)
```

* 1行目では、100個の乱数がベクトルとして変数xに割り当てられます。
* 2行目では、全ての値がプロットウィンドウに描画されています。

## スクリプト

Rはコマンドラインベースの環境を使用するインタプリタです。

つまり、マウスやメニューを使用するのではなく、コマンドを入力する必要があるのです。

これには、必ずしもコマンドを再入力する必要がないという利点があります。

コマンドはファイル、いわゆる*スクリプト*に保存することができます。これらのスクリプトは通常、**script.R**のように　**.R**の拡張子が付いたファイル名を持ちます。

*File > New* または *File > Open file...*からこれらのファイルを編集することができます。

行を選択して **CTRL+ENTER** か **CMD+ENTER** 、スクリプトエディタウィンドウの上部にある *Run* をクリックすると、コードの一部を実行（コンソールウィンドウに送信）できます。何も選択しなければ、Rはカーソルがある行を実行します。

いつでも`source()`を使えばスクリプト全体を実行できます。

例えば、保存済みの **script.R** が作業ディレクトリのルートディレクトリにあり、このスクリプト全体を実行する場合には

```{r run_script, eval=F}
source("script.R")
```

エディタウィンドウで*Run all*を押すか、**CTRL+SHIFT+S**または*CMD+SHIFT+S*と入力しても構いません。


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/tQTWM4W9XxQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0; encrypted-media" allowfullscreen title="YouTube Video"></iframe>
</div>

## 利用できないデータ

実際にデータを扱うとき、計測が失敗したか人的エラーが発生したために、しばしば値が欠落していることがあります。

データが*利用できない*場合には、数字の代わりに`NA`と表記する必要があります。

```{r na}
j <- c(1,2,NA)
```

厳密にいえば、不完全なデータセットの統計をとることは不可能です。

あなたが測定していなかった週末の間に最大の値を発生させる出来事があったかもしれません。したがって、Rは `j` の最大値が何かはわからないと返すでしょう。

```{r na2}
max(j)

```
## [1] NA
欠けているデータに構わず計算したい場合は、引数 `na.rm=TRUE` を追加します(要するに`NA`を除外しますか? Yesということです)。

```{r na3}
max(j, na.rm=T)
```

## [1] 2

{{% notice warning %}}
`NA`はあらゆる計算に影響します。
{{% /notice %}}


```{r na4}
sum(j)
# compared to
sum(j, na.rm=T)
```
## [1] 3

 `NA`を処理するための[いくつかの](http://faculty.nps.edu/sebuttre/home/R/missings.html) [リンクを](https://datascienceplus.com/missing-values-in-r/) [紹介します](https://stats.idre.ucla.edu/r/faq/how-does-r-handle-missing-values/) 。

# データ型

これまでは数値を使ってきました。

しかし、私たちが扱うデータには、文字や **TRUE** または **FALSE** といったブール値、日付などの文字列のように、他のものもあるのです。

## 文字


```{r characters}
m <- "apples"
m
```

文字列であることをRに認識させるには、引用符の間にテキストを入力する必要があります。そうしないと、Rは同じ名前の定義済み変数を探してしまうことになります。

```{r characters2, error=TRUE}
n <- pears
```
## [1] "apples"
文字で計算をすることはできません。

```{r characters3, error=TRUE}
m + 2
```
## Error in m + 2: non-numeric argument to binary operator
## 日付

日付と時間は複雑な概念です。

Rは、3時が2時59分の後に来ること、そして2月は数年に一度29日あることを知っていなければなりません。

日付と時刻の組み合わせであることをRに伝える基本的な方法は`strptime()`関数を使うことです。

```{r dates1}
date1 <- strptime(c("20100225230000", "20100226000000", "20100226010000"), format="%Y%m%d%H%M%S")
date1
```
## [1] "2010-02-25 23:00:00 EST" "2010-02-26 00:00:00 EST"
## [3] "2010-02-26 01:00:00 EST"

関数`c()`によってベクトルが作成され、引用符の間の数字は文字列として扱われます。これは`strptime()`関数を使うために必要な操作です。

文字列の読み方を規定する引数 **format** が後に続いています。この例では、年(%Y)、月(%M)、秒(%S)の順に並んでいます。フォーマットがストリングに対応していれば、全てを指定する必要はありません。

このコースでは**lubridate**パッケージを使用して手間をかけずに日付を処理する方法を使用します。

```{r dates2}
# lubridateパッケージをインストールしていない場合は、以下の行のコメントを外して実行してください。

# install.packages("lubridate")

library(lubridate)

date1 <- ymd_hms(c("20100225230000", "20100226000000", "20100226010000"))
```

`ymd_hms()` は、ストリング内の年、月、日と時、分、秒を変換します。[第3章](http://learn.r-journalism.com/en/wrangling/dates/dates/)でより詳しく説明します。

## 因子

これは複雑な概念です。

* （性別などの）名義尺度や（順位などの）順序尺度を併せて質的データといい、このデータ構造を処理する方法をRに指示します。
*	とても重要な概念にも関わらず、しばしば誤解されています。
*  質的変数または順序尺度の変数は通常、因子として格納されます。

たとえば、人種を「白人」、「黒人」、「ヒスパニック」と入力するとします。

スプレッドシートからそのデータをインポートするとき、Rは大概**因子**として処理します。

以下のコードを実行して、新しいオブジェクト**sample_df**というデータフレームを作ります。

```{r factor1}
sample_df <- data.frame(id=c(1001,1002,1003,1004), name=c("Steve", "Pam", "Jim", "Dwight"), age=c(26, 65, 15, 7), race=c("White", "Black", "White", "Hispanic"))
sample_df$race <- factor(sample_df$race)
sample_df$id <- factor(sample_df$id)
sample_df$name <- as.character(sample_df$name)
```

<img src="/how_to_use_r/intro_to_r/images/sample_df.png" alt="Set working directory", class="shadow", style="width:40%">

作成したデータフレームの背後にある構造を見てみましょう。

```{r factor2}
str(sample_df)
```
## 'data.frame': 4 obs. of 4 variables:
## $ id : Factor w/ 4 levels "1001","1002",..: 1 2 3 4
## $ name: chr "Steve" "Pam" "Jim" "Dwight"
## $ age : num 26 65 15 7
## $ race: Factor w/ 3 levels "Black","Hispanic",..: 3 1 3 2
Rは**Race**列が三つのレベルがある因子変数であると認識しています。

```{r factor3}
levels(sample_df$race)
```
## [1] "Black" "Hispanic" "White"
これはRがこの統計を三つのレベルでグループ化することを示しています。

```{r factor4}
summary(sample_df$race)
```
## Black Hispanic White
## 1 1 2

Rの内部では、文字列をアルファベット順に整数値1、2、および3に割り当てます。1=黒人、2=ヒスパニック、3=白人ということになります。

これを知ることがなぜ重要なのでしょうか。

ジャーナリストは因子を理解することにあまり関心がなく、しばしば因子を文字列や文字に置き換えています。しかし、線形回帰モデルを作成したいという段階にまで到達したら、因子を選択肢の一つとして使えることが有利になります。

{{% notice tip %}}
このようなRの最も理解しがたい点は、Rが統計学者によって、統計学者のために作成されたことに起因するものです。Rは大きく成長し、利用者のコミュニティはデータを慣れ親しんだ方法で扱うように進化させてきました。しかし、理解しがたい点のいくつかはしぶとく生き残っているのです。
{{% /notice %}}

## 整数と数字

計算に使用できるのは整数または10進数です。

Rは数字が混在するユニットを適切に扱うことができません。

たとえば、「4in」は4ではなく文字列として扱われます。


## 異なる型間の変換

以下の点に注意してください。

* 因子を文字列に変換することができます。

```{r convert1}
sample_df$race
as.character(sample_df$race)
```
## [1] White Black White Hispanic
## Levels: Black Hispanic White
## [1] "White" "Black" "White" "Hispanic"

* 文字列を因子に変換することができます。

```{r convert2}
sample_df$name
factor(sample_df$name)
```
## [1] "Steve" "Pam" "Jim" "Dwight"
## [1] Steve Pam Jim Dwight
## Levels: Dwight Jim Pam Steve

* 因子を数値に変換することは **できません** 。

```{r convert3}
sample_df$id
as.numeric(sample_df$id)
```
## [1] 1001 1002 1003 1004
## Levels: 1001 1002 1003 1004
## [1] 1 2 3 4
Rは  **因子** を **整数** として格納するからです。

数値に変換するには *まず* 文字に変換しなければなりません。

そうすれば、ネストすることができるようになります。

```{r convert4}
sample_df$id
as.numeric(as.character(sample_df$id))
```
## [1] 1001 1002 1003 1004
## Levels: 1001 1002 1003 1004
## [1] 1001 1002 1003 1004

{{% notice tip %}}
次のセクションは完全に理解しなくても大丈夫です。だいぶ高度な内容です。**演習**まで飛ばしてもかまいません。
{{% /notice %}}


## 関数再考

プロセスを単純化するために、コードを関数に保存することもできます。

```{r function}
percent_change <- function(first_number, second_number) {
  pc <- (second_number-first_number)/first_number*100
  return(pc)
}

percent_change(100,150)
```
## [1] 50
上記のコードを実行すると、こんなことが起きます:

* **percent_change** は関数の名前で、`function()`関数がこれに割り当てられています。
* **first_number** と **second_number**　という二つの変数が必要です。
* 新たなオブジェクト`pc`は、渡された2つの変数からパーセント変化を計算するして作成されます。
* `return()`は`percent_change` に計算結果を返します。

十分な関数を構築すれば、それらを[自分のパッケージ](https://github.com/andrewbtran/muckrakr)として保存できます。

**関数について大事なこと** はそれらが人間によってプログラムされているということです。

この関数を作成できたのは、入力が二つしかなく、それぞれが数値で、順序が決まっていることを知っているからです。

Rの関数でエラーが発生した場合は、その関数に渡している少なくとも一つの変数に問題がある可能性があります。

`percent_change()`関数に文字列を渡すとこうなります。

```{r function2, error=T}
percent_change("what", "happens")
```
## Error in second_number - first_number: non-numeric argument to binary operator

**This is the point: **

優れたRのプログラマは、あらかじめ不適切な入力によるエラーを予想して、一般的なエラー表示の代わりに役に立つ提案を出力するでしょう。

特定のエラーはあまり明白ではありません。エラーを解釈する **あなた** は関数が正しく機能するために数字が必要なことを知っています。

しかし新しいユーザーはそれを知らないかもしれません。

これは、あなたが関数が機能しないときに感じることと同じです。

エラーをGoogleで確認するか、コードを覗いて、エラーの原因を確認できるかどうか、または関数に引数を渡したらエラーが発生する可能性があるかどうかを確認します。

私たちがコーディングして他の人と共有しているとき、他の人が使うであろうすべての方法を予測することはできません。

関数の作成者にメッセージを送るか、パッケージを書いた場合は他の人からのフィードバックを歓迎すべきです。

この仕組みがRコミュニティに参加することをとても素晴らしいものにしています。私たちは改善を追求しているのです。

## 演習

[演習](http://code.r-journalism.com/chapter-1/#section-intro-to-r) で知識を身につけましょう。

エクササイズアプリの実行方法に関する説明は、このセクションの [紹介ページ](http://learn.r-journalism.com/en/how_to_use_r/) にあります。
